#!/usr/bin/env bash

function jq_inplace {
  TMP=$(mktemp)
  jq "$1" > $TMP && mv $TMP "$2"
}

function sed_inplace {
  # sed's -i argument behaves differently on macOS, hence this hack
  sed -i.bak "$1" $2 && rm $2.bak
}

function deploy_mcd_dds {
  #increase nonce to avoid contract address collision with scd snapshot
  for i in {1..50}
  do
    seth send --value 0.0005 0xAceBabe64807cb045505b268ef253D8fC2FeF5Bc #random address
    echo "sent 0.0005 eth"
  done

  DDS=$LIB/dss-deploy-scripts
  cd $DDS

  export MCD_PAUSE_DELAY=1

  TMP=$(mktemp)

  OMNIA_AMOUNT="1"
  DEPLOY=$DDS/config/testchain.json
  cat $DEPLOY | jq_inplace ".omniaAmount = $(echo $OMNIA_AMOUNT)" $DEPLOY

  # change ds-pause delay to non-zero
  cat $DEPLOY | jq_inplace ".pauseDelay = $(echo $MCD_PAUSE_DELAY)" $DEPLOY

  # submodule contracts are deprecated; this nix command
  # installs all necessary dependencies
  ETH_RPC_URL="http://localhost:2000" nix run -f ./ -c dss-deploy testchain

  # Copy addresses and abis
  jq -S . $DDS/out/addresses.json > $OUT/addresses-mcd.json
  sudo cp $DDS/out/abi/*.abi $OUT/mcd

  # all done, go home!
  cd -
}
